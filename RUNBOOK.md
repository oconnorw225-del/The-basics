# Execution Package Manual Operations Runbook

## Overview

This runbook provides step-by-step instructions for safely executing Bitcoin transactions using the execution package generated by the consolidation workflow. **All transaction signing and broadcasting must be performed manually by authorized operators.**

## Important Security Notes

⚠️ **CRITICAL SAFETY INFORMATION:**
- The CI system **NEVER** creates, signs, or broadcasts transactions
- Production private keys are **NEVER** stored in CI or committed to code
- All transaction signing **MUST** be performed offline on air-gapped or hardware wallet devices
- All transactions **MUST** be reviewed and approved by authorized personnel before broadcasting
- This is a **MANUAL PROCESS** that requires human approval at every step

## Prerequisites

### Required Tools
- `jq` - JSON processor for manifest parsing
- `bitcoin-cli` or compatible Bitcoin wallet software
- Hardware wallet (Ledger, Trezor, etc.) or secure HSM
- Access to GitHub Actions artifacts
- Testnet node for dry runs (recommended)

### Required Access
- GitHub repository access to download artifacts
- Authorization to approve the `withdrawal-approval` environment
- Access to secure signing infrastructure (air-gapped machine or hardware wallet)
- Access to broadcasting node (production or testnet)

## Step 1: Download Execution Package

### Via GitHub Actions UI
1. Navigate to the completed workflow run in GitHub Actions
2. Scroll to the "Artifacts" section
3. Download the `execution-package` artifact (ZIP file)
4. Verify the file integrity using checksums if available

### Via GitHub CLI
```bash
# List recent workflow runs
gh run list --workflow=consolidate.yml --limit 5

# Download artifacts from specific run
gh run download <RUN_ID> --name execution-package

# Extract the package
unzip execution_package.zip
cd execution
```

## Step 2: Review the Execution Package

### Verify Package Contents
```bash
# Check all files are present
ls -la

# Expected files:
# - manifest.json (masked, no secrets)
# - unsigned_tx_info.txt (instructions)
# - scan_results/ (security scan results)
# - backups/ (backup archives)
# - test_results/ (test results)
```

### Review the Manifest
```bash
# Pretty-print the manifest
jq '.' manifest.json

# Check for specific fields
jq '.transactions' manifest.json  # Review transaction details
jq '.recipients' manifest.json     # Verify recipient addresses
jq '.amounts' manifest.json        # Verify transfer amounts
jq '.fees' manifest.json           # Check fee estimates

# Verify no secrets are present
jq 'keys' manifest.json | grep -i secret && echo "⚠️ SECRETS FOUND" || echo "✓ No secrets"
```

### Review Test Results
```bash
# Check test results
jq '.' test_results/test_results.json

# Verify all critical tests passed
jq '.status' test_results/test_results.json
jq '.failures' test_results/test_results.json
```

### Review Security Scans
```bash
# Check for security issues
ls scan_results/

# Review any findings
cat scan_results/*.txt
cat scan_results/*.json
```

## Step 3: Create Unsigned Transaction (PSBT)

**⚠️ PERFORM THIS STEP ON AN AIR-GAPPED MACHINE**

### Testnet Dry Run (Recommended First)

```bash
# Set testnet mode
export BITCOIN_NETWORK="testnet"

# Parse transaction details from manifest
RECIPIENT=$(jq -r '.recipient_address' manifest.json)
AMOUNT=$(jq -r '.amount_btc' manifest.json)
SOURCE_UTXO=$(jq -r '.source_utxo' manifest.json)

# Create unsigned PSBT using bitcoin-cli (testnet)
bitcoin-cli -testnet createpsbt \
  "[{\"txid\":\"$SOURCE_UTXO\",\"vout\":0}]" \
  "[{\"$RECIPIENT\":$AMOUNT}]" \
  > unsigned_transaction.psbt

# Or using bitcoin-qt GUI on testnet:
# 1. Open bitcoin-qt with -testnet flag
# 2. Go to Send tab
# 3. Enter recipient address and amount
# 4. Click "Create Unsigned" 
# 5. Save PSBT file

# Verify PSBT structure
bitcoin-cli -testnet decodepsbt $(cat unsigned_transaction.psbt)
```

### Production Transaction Creation

```bash
# ONLY proceed if testnet dry run was successful
export BITCOIN_NETWORK="mainnet"

# Parse transaction details
RECIPIENT=$(jq -r '.recipient_address' manifest.json)
AMOUNT=$(jq -r '.amount_btc' manifest.json)
FEE_RATE=$(jq -r '.fee_rate_sat_vbyte' manifest.json)

# Create PSBT on air-gapped machine
bitcoin-cli createpsbt \
  "[{\"txid\":\"$SOURCE_UTXO\",\"vout\":0}]" \
  "[{\"$RECIPIENT\":$AMOUNT}]" \
  0 \
  "{\"feeRate\":$FEE_RATE}" \
  > unsigned_transaction.psbt

# CRITICAL: Review the PSBT before proceeding
bitcoin-cli decodepsbt $(cat unsigned_transaction.psbt)
```

## Step 4: Sign the Transaction

**⚠️ SIGNING MUST BE DONE ON SECURE HARDWARE**

### Using Hardware Wallet (Ledger/Trezor)

```bash
# Connect hardware wallet to air-gapped machine

# Using HWI (Hardware Wallet Interface)
hwi --testnet signtx unsigned_transaction.psbt > signed_transaction.psbt

# Or using bitcoin-cli with HWI
bitcoin-cli -testnet walletprocesspsbt $(cat unsigned_transaction.psbt)

# For production:
hwi signtx unsigned_transaction.psbt > signed_transaction.psbt
```

### Using Multi-Signature Process

```bash
# For m-of-n multisig wallets
# Each signer must sign the PSBT sequentially

# Signer 1:
bitcoin-cli walletprocesspsbt $(cat unsigned_transaction.psbt) > partially_signed_1.psbt

# Transfer to Signer 2 (via secure channel)
bitcoin-cli walletprocesspsbt $(cat partially_signed_1.psbt) > partially_signed_2.psbt

# Continue until threshold reached
# Final signer produces fully signed transaction

# Verify all required signatures
bitcoin-cli analyzepsbt $(cat signed_transaction.psbt)
```

## Step 5: Verify the Signed Transaction

**⚠️ CRITICAL VERIFICATION STEP - DO NOT SKIP**

```bash
# Decode the signed transaction
bitcoin-cli decodepsbt $(cat signed_transaction.psbt)

# Finalize PSBT to raw transaction
bitcoin-cli finalizepsbt $(cat signed_transaction.psbt) > finalized_tx.json

# Extract raw transaction
RAW_TX=$(jq -r '.hex' finalized_tx.json)

# Decode and verify the raw transaction
bitcoin-cli decoderawtransaction "$RAW_TX"

# Verify transaction details match manifest:
# ✓ Recipient address matches manifest
# ✓ Amount matches manifest (within dust tolerance)
# ✓ Fee is reasonable and expected
# ✓ No unexpected outputs
# ✓ All signatures valid

# Test transaction validity (testnet only)
bitcoin-cli -testnet testmempoolaccept "[\"$RAW_TX\"]"
```

### Verification Checklist

- [ ] Recipient address matches manifest exactly
- [ ] Amount in BTC matches manifest (accounting for fees)
- [ ] Fee rate is reasonable and within expected range
- [ ] No unexpected change outputs to unknown addresses
- [ ] Transaction size is reasonable
- [ ] All signatures present and valid
- [ ] Testnet dry run completed successfully (if applicable)
- [ ] Authorized approver has reviewed and approved

## Step 6: Broadcast the Transaction

**⚠️ ONLY BROADCAST AFTER FULL VERIFICATION AND APPROVAL**

### Testnet Broadcast (Dry Run)

```bash
# Broadcast to testnet first
bitcoin-cli -testnet sendrawtransaction "$RAW_TX"

# Monitor transaction
TXID=$(bitcoin-cli -testnet sendrawtransaction "$RAW_TX")
echo "Testnet TXID: $TXID"

# Watch for confirmations
watch bitcoin-cli -testnet gettransaction "$TXID"

# Verify on testnet block explorer
echo "https://blockstream.info/testnet/tx/$TXID"
```

### Production Broadcast

```bash
# FINAL APPROVAL CHECKPOINT
echo "⚠️  FINAL APPROVAL REQUIRED ⚠️"
echo "About to broadcast transaction to MAINNET"
echo "Recipient: $RECIPIENT"
echo "Amount: $AMOUNT BTC"
read -p "Type 'CONFIRM' to proceed: " CONFIRM

if [ "$CONFIRM" != "CONFIRM" ]; then
  echo "Broadcast cancelled"
  exit 1
fi

# Broadcast transaction
TXID=$(bitcoin-cli sendrawtransaction "$RAW_TX")

echo "✓ Transaction broadcast successfully"
echo "TXID: $TXID"
echo "https://blockstream.info/tx/$TXID"

# Log the transaction
echo "$(date -u +%Y-%m-%dT%H:%M:%SZ) - TX $TXID - $AMOUNT BTC to $RECIPIENT" >> transaction_log.txt
```

### Post-Broadcast Monitoring

```bash
# Monitor for confirmations
watch -n 60 bitcoin-cli gettransaction "$TXID"

# Check mempool status
bitcoin-cli getmempoolentry "$TXID"

# Wait for confirmations (recommended: 6 confirmations)
while [ $(bitcoin-cli gettransaction "$TXID" | jq -r '.confirmations') -lt 6 ]; do
  echo "Confirmations: $(bitcoin-cli gettransaction "$TXID" | jq -r '.confirmations')/6"
  sleep 300  # Check every 5 minutes
done

echo "✓ Transaction confirmed with 6+ confirmations"
```

## Step 7: Document and Archive

```bash
# Create execution record
cat > execution_record.json <<EOF
{
  "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "txid": "$TXID",
  "recipient": "$RECIPIENT",
  "amount_btc": "$AMOUNT",
  "operator": "$(whoami)",
  "manifest_hash": "$(sha256sum manifest.json | cut -d' ' -f1)",
  "workflow_run_id": "<GITHUB_RUN_ID>",
  "approval_granted_by": "<APPROVER_NAME>",
  "confirmation_count": 6
}
EOF

# Archive all files
tar czf execution_archive_$(date +%Y%m%d_%H%M%S).tar.gz \
  manifest.json \
  unsigned_transaction.psbt \
  signed_transaction.psbt \
  finalized_tx.json \
  execution_record.json \
  transaction_log.txt

# Store archive securely (encrypted backup)
# Example: Upload to secure cloud storage or HSM
```

## Troubleshooting

### Common Issues

**Issue: PSBT creation fails**
```bash
# Check wallet is loaded
bitcoin-cli listwallets

# Load wallet if needed
bitcoin-cli loadwallet "mywallet"

# Check UTXOs available
bitcoin-cli listunspent
```

**Issue: Insufficient funds**
```bash
# Check wallet balance
bitcoin-cli getbalance

# List all UTXOs
bitcoin-cli listunspent

# Adjust amount or consolidate UTXOs
```

**Issue: Fee too low (transaction not confirming)**
```bash
# Check current fee market
bitcoin-cli estimatesmartfee 6  # 6 blocks

# Create RBF (Replace-By-Fee) transaction with higher fee
bitcoin-cli bumpfee "$TXID"
```

**Issue: Transaction rejected by mempool**
```bash
# Check error message
bitcoin-cli testmempoolaccept "[\"$RAW_TX\"]"

# Common causes:
# - Insufficient fee
# - Double spend
# - Invalid signatures
# - Dust outputs
```

### Emergency Procedures

**If transaction needs to be cancelled (before broadcast):**
- Simply do not broadcast the signed transaction
- The PSBT can be discarded
- No on-chain action has occurred

**If transaction broadcast but not confirming:**
- Wait for mempool to clear (may take days)
- Use RBF if enabled: `bitcoin-cli bumpfee "$TXID"`
- Contact operations team for guidance

**If wrong transaction broadcast:**
- **CANNOT BE REVERSED ON BITCOIN**
- Document the incident immediately
- Contact recipient if possible
- Follow incident response procedures
- Review process to prevent recurrence

## Compliance and Audit Trail

All manual execution steps must be documented:

1. **Pre-Execution Checklist** - Completed before Step 3
2. **Verification Checklist** - Completed at Step 5
3. **Approval Record** - Signed by authorized approver
4. **Execution Record** - JSON file with all transaction details
5. **Archive** - Encrypted tar.gz with all files

Store all records in compliance with organizational policies (typically 7 years).

## Contact and Support

**For urgent issues during execution:**
- Operations Team: [Contact Info]
- Security Team: [Contact Info]
- On-Call Engineer: [Contact Info]

**For questions about this runbook:**
- Repository Owner: oconnorw225-del
- Documentation: See repository README.md and SECURITY.md

---

**Last Updated:** 2026-01-11  
**Version:** 1.0  
**Review Frequency:** Quarterly
