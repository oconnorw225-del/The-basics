name: ğŸš€ Complete AWS Setup & Deploy

on:
  workflow_dispatch:
    inputs:
      setup_type:
        description: 'Setup type'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - infrastructure-only
          - deploy-only
      environment:
        description: 'Environment'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production

jobs:
  validate-prerequisites:
    name: âœ… Validate Prerequisites
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check AWS credentials
        run: |
          echo "Checking AWS credentials..."
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "âŒ AWS_ACCESS_KEY_ID secret not set"
            exit 1
          fi
          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "âŒ AWS_SECRET_ACCESS_KEY secret not set"
            exit 1
          fi
          echo "âœ… AWS credentials configured"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Verify AWS access
        run: |
          echo "Verifying AWS access..."
          aws sts get-caller-identity
          echo "âœ… AWS access verified"

      - name: Display setup plan
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Chimera AWS Setup Plan"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Setup Type: ${{ github.event.inputs.setup_type }}"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo ""
          echo "This workflow will:"
          if [ "${{ github.event.inputs.setup_type }}" = "full" ] || [ "${{ github.event.inputs.setup_type }}" = "infrastructure-only" ]; then
            echo "  1. âœ… Create VPC and networking"
            echo "  2. âœ… Set up ECS cluster"
            echo "  3. âœ… Create Application Load Balancer"
            echo "  4. âœ… Configure ECR repository"
            echo "  5. âœ… Set up CloudWatch monitoring"
            echo "  6. âœ… Configure auto-scaling"
          fi
          if [ "${{ github.event.inputs.setup_type }}" = "full" ] || [ "${{ github.event.inputs.setup_type }}" = "deploy-only" ]; then
            echo "  7. âœ… Build Docker image"
            echo "  8. âœ… Deploy to ECS"
            echo "  9. âœ… Verify deployment"
          fi
          echo ""
          echo "Estimated time: 5-8 minutes"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  setup-infrastructure:
    name: ğŸ—ï¸ Setup AWS Infrastructure
    needs: validate-prerequisites
    if: ${{ github.event.inputs.setup_type == 'full' || github.event.inputs.setup_type == 'infrastructure-only' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    environment:
      name: ${{ github.event.inputs.environment }}
    outputs:
      load_balancer_dns: ${{ steps.tf-outputs.outputs.load_balancer_dns }}
      ecr_repository_url: ${{ steps.tf-outputs.outputs.ecr_repository_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: ./aws/terraform
        run: |
          echo "Initializing Terraform..."
          terraform init

      - name: Terraform Plan
        working-directory: ./aws/terraform
        run: |
          echo "Creating infrastructure plan..."
          terraform plan \
            -var="environment=${{ github.event.inputs.environment }}" \
            -out=tfplan

      - name: Terraform Apply
        working-directory: ./aws/terraform
        run: |
          echo "Applying infrastructure changes..."
          terraform apply -auto-approve tfplan
          echo "âœ… Infrastructure created successfully"

      - name: Get Infrastructure Outputs
        id: tf-outputs
        working-directory: ./aws/terraform
        run: |
          echo "load_balancer_dns=$(terraform output -raw load_balancer_dns)" >> $GITHUB_OUTPUT
          echo "ecr_repository_url=$(terraform output -raw ecr_repository_url)" >> $GITHUB_OUTPUT

      - name: Infrastructure Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… AWS Infrastructure Created Successfully"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸŒ Load Balancer: ${{ steps.tf-outputs.outputs.load_balancer_dns }}"
          echo "ğŸ“¦ ECR Repository: ${{ steps.tf-outputs.outputs.ecr_repository_url }}"
          echo ""
          echo "Your infrastructure is ready!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  deploy-application:
    name: ğŸš€ Deploy Application
    needs: [validate-prerequisites, setup-infrastructure]
    if: |
      always() &&
      needs.validate-prerequisites.result == 'success' &&
      (needs.setup-infrastructure.result == 'success' || needs.setup-infrastructure.result == 'skipped') &&
      (github.event.inputs.setup_type == 'full' || github.event.inputs.setup_type == 'deploy-only')
    runs-on: ubuntu-latest
    permissions:
      contents: read
    environment:
      name: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Building Docker image..."
          docker build -t chimera-system:latest .
          docker tag chimera-system:latest $ECR_REGISTRY/chimera-system:$IMAGE_TAG
          docker tag chimera-system:latest $ECR_REGISTRY/chimera-system:latest
          echo "âœ… Docker image built"

      - name: Push to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Pushing image to ECR..."
          docker push $ECR_REGISTRY/chimera-system:$IMAGE_TAG
          docker push $ECR_REGISTRY/chimera-system:latest
          echo "âœ… Image pushed to ECR"

      - name: Update ECS service
        run: |
          echo "Updating ECS service..."
          aws ecs update-service \
            --cluster chimera-cluster \
            --service chimera-service \
            --force-new-deployment \
            --region us-east-1
          echo "âœ… ECS service updated"

      - name: Wait for deployment
        run: |
          echo "Waiting for deployment to complete..."
          aws ecs wait services-stable \
            --cluster chimera-cluster \
            --services chimera-service \
            --region us-east-1
          echo "âœ… Deployment completed"

  deployment-summary:
    name: ğŸ“Š Deployment Summary
    needs: [setup-infrastructure, deploy-application]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Display final summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Chimera AWS Setup Complete!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… Status:"
          echo "  Infrastructure: ${{ needs.setup-infrastructure.result || 'skipped' }}"
          echo "  Deployment: ${{ needs.deploy-application.result || 'skipped' }}"
          echo ""
          if [ "${{ needs.setup-infrastructure.outputs.load_balancer_dns }}" != "" ]; then
            echo "ğŸŒ Your application is available at:"
            echo "  http://${{ needs.setup-infrastructure.outputs.load_balancer_dns }}"
            echo ""
          fi
          echo "ğŸ“Š Next Steps:"
          echo "  1. Access your application using the URL above"
          echo "  2. Check monitoring: GitHub Actions â†’ AWS Monitoring workflow"
          echo "  3. View costs: python aws/cost-calculator.py"
          echo "  4. See logs: aws logs tail /ecs/chimera-system --follow"
          echo ""
          echo "ğŸ“š Documentation:"
          echo "  â€¢ Quick Start: aws/QUICKSTART.md"
          echo "  â€¢ Full Guide: aws/README_AWS_DEPLOYMENT.md"
          echo "  â€¢ All Options: DEPLOYMENT.md"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
