name: Consolidate Best Parts

on:
  workflow_dispatch:

jobs:
  consolidate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the-basics repository
        uses: actions/checkout@v4

      - name: Clone source repositories
        run: |
          mkdir source
          git clone https://github.com/oconnorw225-del/ndax-quantum-engine.git source/ndax-quantum-engine
          git clone https://github.com/oconnorw225-del/quantum-engine-dashb.git source/quantum-engine-dashb
          git clone https://github.com/oconnorw225-del/shadowforge-ai-trader.git source/shadowforge-ai-trader
          git clone https://github.com/oconnorw225-del/repository-web-app.git source/repository-web-app
          git clone https://github.com/oconnorw225-del/The-new-ones.git source/The-new-ones

      - name: Create and Upload Backups
        run: |
          mkdir backups
          tar czf backups/ndax-quantum-engine.tar.gz -C source ndax-quantum-engine
          tar czf backups/quantum-engine-dashb.tar.gz -C source quantum-engine-dashb
          tar czf backups/shadowforge-ai-trader.tar.gz -C source shadowforge-ai-trader
          tar czf backups/repository-web-app.tar.gz -C source repository-web-app
          tar czf backups/The-new-ones.tar.gz -C source The-new-ones
      
      - name: Upload backups as artifact
        uses: actions/upload-artifact@v3
        with:
          name: source-code-backups
          path: backups/

      - name: Setup directory structure
        run: |
          mkdir -p api backend frontend workflows docs automation tests

      - name: Run consolidation script
        run: |
          bash automation/consolidate.sh

      - name: Commit consolidated code
        run: |
          # The backups directory should not be committed to the repo
          rm -rf backups/

          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git add .
          git diff --staged --quiet || git commit -m "Automated consolidation of best parts - $(date -u +%Y-%m-%d)"
          git push
