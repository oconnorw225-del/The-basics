name: Consolidate Best Parts

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  consolidate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the-basics repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Clone source repositories
        continue-on-error: true
        id: clone-repos
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Cloning Source Repositories"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Configure git to not prompt for any interactive input
          export GIT_TERMINAL_PROMPT=0
          
          mkdir -p source
          CLONED_COUNT=0
          
          echo "Attempting to clone repositories..."
          if git clone https://github.com/oconnorw225-del/ndax-quantum-engine.git source/ndax-quantum-engine 2>/dev/null; then
            echo "âœ… Cloned ndax-quantum-engine"
            CLONED_COUNT=$((CLONED_COUNT + 1))
          else
            echo "âš ï¸  Failed to clone ndax-quantum-engine (may be private or not exist)"
          fi
          
          if git clone https://github.com/oconnorw225-del/quantum-engine-dashb.git source/quantum-engine-dashb 2>/dev/null; then
            echo "âœ… Cloned quantum-engine-dashb"
            CLONED_COUNT=$((CLONED_COUNT + 1))
          else
            echo "âš ï¸  Failed to clone quantum-engine-dashb (may be private or not exist)"
          fi
          
          if git clone https://github.com/oconnorw225-del/shadowforge-ai-trader.git source/shadowforge-ai-trader 2>/dev/null; then
            echo "âœ… Cloned shadowforge-ai-trader"
            CLONED_COUNT=$((CLONED_COUNT + 1))
          else
            echo "âš ï¸  Failed to clone shadowforge-ai-trader (may be private or not exist)"
          fi
          
          if git clone https://github.com/oconnorw225-del/repository-web-app.git source/repository-web-app 2>/dev/null; then
            echo "âœ… Cloned repository-web-app"
            CLONED_COUNT=$((CLONED_COUNT + 1))
          else
            echo "âš ï¸  Failed to clone repository-web-app (may be private or not exist)"
          fi
          
          if git clone https://github.com/oconnorw225-del/The-new-ones.git source/The-new-ones 2>/dev/null; then
            echo "âœ… Cloned The-new-ones"
            CLONED_COUNT=$((CLONED_COUNT + 1))
          else
            echo "âš ï¸  Failed to clone The-new-ones (may be private or not exist)"
          fi
          
          echo ""
          echo "Successfully cloned $CLONED_COUNT out of 5 repositories"
          echo "repos_cloned=$CLONED_COUNT" >> $GITHUB_OUTPUT
          
          if [ $CLONED_COUNT -eq 0 ]; then
            echo ""
            echo "âš ï¸  WARNING: No repositories were successfully cloned."
            echo "   This may be because:"
            echo "   - Repositories are private (need GITHUB_TOKEN with proper permissions)"
            echo "   - Repositories don't exist"
            echo "   - Network connectivity issues"
            echo ""
            echo "Consolidation workflow will be skipped."
          fi

      - name: Archive backups
        if: steps.clone-repos.outputs.repos_cloned != '0'
        continue-on-error: true
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Creating Backup Archives"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          mkdir -p backups
          [ -d source/ndax-quantum-engine ] && tar czf backups/ndax-quantum-engine.tar.gz -C source ndax-quantum-engine && echo "âœ… Archived ndax-quantum-engine" || true
          [ -d source/quantum-engine-dashb ] && tar czf backups/quantum-engine-dashb.tar.gz -C source quantum-engine-dashb && echo "âœ… Archived quantum-engine-dashb" || true
          [ -d source/shadowforge-ai-trader ] && tar czf backups/shadowforge-ai-trader.tar.gz -C source shadowforge-ai-trader && echo "âœ… Archived shadowforge-ai-trader" || true
          [ -d source/repository-web-app ] && tar czf backups/repository-web-app.tar.gz -C source repository-web-app && echo "âœ… Archived repository-web-app" || true
          [ -d source/The-new-ones ] && tar czf backups/The-new-ones.tar.gz -C source The-new-ones && echo "âœ… Archived The-new-ones" || true
          
          ARCHIVE_COUNT=$(ls -1 backups/*.tar.gz 2>/dev/null | wc -l)
          echo ""
          echo "Created $ARCHIVE_COUNT backup archive(s)"

      - name: Setup directory structure
        if: steps.clone-repos.outputs.repos_cloned != '0'
        run: |
          mkdir -p api backend frontend .github/workflows docs automation tests

      - name: Run consolidation script
        if: steps.clone-repos.outputs.repos_cloned != '0'
        continue-on-error: true
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ Running Consolidation Script"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -f "automation/consolidate.sh" ]; then
            bash automation/consolidate.sh
            echo "âœ… Consolidation script completed"
          else
            echo "âš ï¸  Consolidation script not found at automation/consolidate.sh"
          fi

      - name: Commit consolidated code
        if: steps.clone-repos.outputs.repos_cloned != '0'
        continue-on-error: true
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ’¾ Committing Changes"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Configure git to not prompt for any interactive input
          export GIT_TERMINAL_PROMPT=0
          
          git config --global user.email "ci-bot@example.com"
          git config --global user.name "CI Bot"
          git add .
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to commit"
          else
            git commit -m "Automated consolidation of best parts"
            git push
            echo "âœ… Changes committed and pushed"
          fi
      
      - name: Workflow Summary
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Consolidation Workflow Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Repositories cloned: ${{ steps.clone-repos.outputs.repos_cloned }}/5"
          echo ""
          
          if [ "${{ steps.clone-repos.outputs.repos_cloned }}" = "0" ]; then
            echo "âš ï¸  No repositories were available for consolidation."
            echo ""
            echo "This is expected if:"
            echo "  â€¢ Source repositories are private or don't exist"
            echo "  â€¢ GITHUB_TOKEN doesn't have access to private repos"
            echo ""
            echo "To enable consolidation:"
            echo "  1. Ensure source repositories exist and are accessible"
            echo "  2. Configure personal access token with repo access if needed"
          else
            echo "âœ… Consolidation completed successfully"
          fi
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
