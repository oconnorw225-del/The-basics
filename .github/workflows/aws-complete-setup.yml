name: ğŸš€ AWS Complete Setup & Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production
      setup_type:
        description: 'Setup type'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - infrastructure-only
          - deploy-only
      auto_destroy:
        description: 'Auto-destroy resources after deployment (for testing)'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: us-east-1
  PROJECT_NAME: chimera
  TERRAFORM_VERSION: '1.6.0'

jobs:
  validate-prerequisites:
    name: âœ… Validate Prerequisites
    runs-on: ubuntu-latest
    outputs:
      aws_account_id: ${{ steps.get-account.outputs.account_id }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required secrets
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Validating Prerequisites"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "âŒ ERROR: AWS_ACCESS_KEY_ID secret not configured"
            echo ""
            echo "Please configure AWS secrets in repository settings:"
            echo "Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret"
            exit 1
          fi
          
          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "âŒ ERROR: AWS_SECRET_ACCESS_KEY secret not configured"
            echo ""
            echo "Please configure AWS secrets in repository settings:"
            echo "Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret"
            exit 1
          fi
          
          echo "âœ… Required secrets are configured"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS access
        id: get-account
        run: |
          set -euo pipefail
          echo "Verifying AWS access..."
          
          ACCOUNT_INFO=$(aws sts get-caller-identity)
          ACCOUNT_ID=$(echo $ACCOUNT_INFO | jq -r '.Account')
          USER_ARN=$(echo $ACCOUNT_INFO | jq -r '.Arn')
          
          echo "âœ… AWS access verified"
          echo "Account ID: $ACCOUNT_ID"
          echo "User: $USER_ARN"
          echo ""
          
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT

      - name: Validate Terraform files
        run: |
          echo "Checking Terraform configuration files..."
          
          if [ ! -f "aws/terraform/main.tf" ]; then
            echo "âŒ ERROR: aws/terraform/main.tf not found"
            exit 1
          fi
          
          if [ ! -f "aws/terraform/variables.tf" ]; then
            echo "âŒ ERROR: aws/terraform/variables.tf not found"
            exit 1
          fi
          
          if [ ! -f "aws/terraform/outputs.tf" ]; then
            echo "âŒ ERROR: aws/terraform/outputs.tf not found"
            exit 1
          fi
          
          echo "âœ… Terraform files validated"

      - name: Validate Dockerfile
        run: |
          echo "Checking Dockerfile..."
          
          if [ ! -f "Dockerfile" ]; then
            echo "âŒ ERROR: Dockerfile not found"
            exit 1
          fi
          
          echo "âœ… Dockerfile found"

      - name: Display deployment plan
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Deployment Plan"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Environment:    ${{ github.event.inputs.environment }}"
          echo "Setup Type:     ${{ github.event.inputs.setup_type }}"
          echo "Auto-destroy:   ${{ github.event.inputs.auto_destroy }}"
          echo "AWS Region:     ${{ env.AWS_REGION }}"
          echo "Project:        ${{ env.PROJECT_NAME }}"
          echo ""
          
          if [ "${{ github.event.inputs.setup_type }}" = "full" ] || [ "${{ github.event.inputs.setup_type }}" = "infrastructure-only" ]; then
            echo "Infrastructure Steps:"
            echo "  1. âœ… Create VPC with public/private subnets"
            echo "  2. âœ… Setup Internet Gateway and NAT Gateway"
            echo "  3. âœ… Configure Application Load Balancer"
            echo "  4. âœ… Create ECS Cluster with Fargate"
            echo "  5. âœ… Setup ECR repository"
            echo "  6. âœ… Configure CloudWatch logging"
            echo "  7. âœ… Setup auto-scaling policies"
            echo "  8. âœ… Configure security groups and IAM roles"
            echo ""
          fi
          
          if [ "${{ github.event.inputs.setup_type }}" = "full" ] || [ "${{ github.event.inputs.setup_type }}" = "deploy-only" ]; then
            echo "Deployment Steps:"
            echo "  1. âœ… Build Docker image"
            echo "  2. âœ… Push to ECR"
            echo "  3. âœ… Update ECS service"
            echo "  4. âœ… Wait for stability"
            echo "  5. âœ… Verify health checks"
            echo ""
          fi
          
          echo "Estimated Duration: 5-8 minutes"
          echo "Estimated Monthly Cost: $50-100 USD"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  setup-infrastructure:
    name: ğŸ—ï¸ Setup AWS Infrastructure
    needs: validate-prerequisites
    if: ${{ github.event.inputs.setup_type == 'full' || github.event.inputs.setup_type == 'infrastructure-only' }}
    runs-on: ubuntu-latest
    outputs:
      load_balancer_dns: ${{ steps.tf-outputs.outputs.load_balancer_dns }}
      ecr_repository_url: ${{ steps.tf-outputs.outputs.ecr_repository_url }}
      ecs_cluster_name: ${{ steps.tf-outputs.outputs.ecs_cluster_name }}
      ecs_service_name: ${{ steps.tf-outputs.outputs.ecs_service_name }}
      application_url: ${{ steps.tf-outputs.outputs.application_url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: ./aws/terraform
        run: |
          set -euo pipefail
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”§ Initializing Terraform"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          terraform init
          echo "âœ… Terraform initialized"

      - name: Terraform Validate
        working-directory: ./aws/terraform
        run: |
          set -euo pipefail
          echo "Validating Terraform configuration..."
          terraform validate
          echo "âœ… Terraform configuration is valid"

      - name: Check for existing resources
        continue-on-error: true
        run: |
          echo "Checking for existing infrastructure..."
          
          # Check for existing cluster
          if aws ecs describe-clusters --clusters ${{ env.PROJECT_NAME }}-cluster --region ${{ env.AWS_REGION }} 2>/dev/null | grep -q "ACTIVE"; then
            echo "âš ï¸  WARNING: ECS cluster already exists"
            echo "This deployment will update existing resources"
          fi

      - name: Terraform Plan
        working-directory: ./aws/terraform
        run: |
          set -euo pipefail
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Creating Infrastructure Plan"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          terraform plan \
            -var="environment=${{ github.event.inputs.environment }}" \
            -var="aws_region=${{ env.AWS_REGION }}" \
            -var="project_name=${{ env.PROJECT_NAME }}" \
            -out=tfplan
          
          echo "âœ… Infrastructure plan created"

      - name: Terraform Apply
        working-directory: ./aws/terraform
        run: |
          set -euo pipefail
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Applying Infrastructure Changes"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          terraform apply -auto-approve tfplan
          
          echo "âœ… Infrastructure created successfully"

      - name: Get Infrastructure Outputs
        id: tf-outputs
        working-directory: ./aws/terraform
        run: |
          set -euo pipefail
          echo "Retrieving infrastructure outputs..."
          
          LOAD_BALANCER_DNS=$(terraform output -raw load_balancer_dns)
          ECR_REPOSITORY_URL=$(terraform output -raw ecr_repository_url)
          ECS_CLUSTER_NAME=$(terraform output -raw ecs_cluster_name)
          ECS_SERVICE_NAME=$(terraform output -raw ecs_service_name)
          APPLICATION_URL=$(terraform output -raw application_url)
          
          echo "load_balancer_dns=$LOAD_BALANCER_DNS" >> $GITHUB_OUTPUT
          echo "ecr_repository_url=$ECR_REPOSITORY_URL" >> $GITHUB_OUTPUT
          echo "ecs_cluster_name=$ECS_CLUSTER_NAME" >> $GITHUB_OUTPUT
          echo "ecs_service_name=$ECS_SERVICE_NAME" >> $GITHUB_OUTPUT
          echo "application_url=$APPLICATION_URL" >> $GITHUB_OUTPUT
          
          echo "âœ… Outputs retrieved"

      - name: Infrastructure Summary
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… AWS Infrastructure Created Successfully"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸŒ Load Balancer DNS: ${{ steps.tf-outputs.outputs.load_balancer_dns }}"
          echo "ğŸ“¦ ECR Repository:    ${{ steps.tf-outputs.outputs.ecr_repository_url }}"
          echo "ğŸ–¥ï¸  ECS Cluster:       ${{ steps.tf-outputs.outputs.ecs_cluster_name }}"
          echo "ğŸ”§ ECS Service:       ${{ steps.tf-outputs.outputs.ecs_service_name }}"
          echo ""
          echo "Your infrastructure is ready for deployment!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  deploy-application:
    name: ğŸš€ Deploy Application
    needs: [validate-prerequisites, setup-infrastructure]
    if: |
      always() &&
      needs.validate-prerequisites.result == 'success' &&
      (needs.setup-infrastructure.result == 'success' || needs.setup-infrastructure.result == 'skipped') &&
      (github.event.inputs.setup_type == 'full' || github.event.inputs.setup_type == 'deploy-only')
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get ECR repository URL
        id: get-ecr
        run: |
          set -euo pipefail
          
          if [ -n "${{ needs.setup-infrastructure.outputs.ecr_repository_url }}" ]; then
            ECR_URL="${{ needs.setup-infrastructure.outputs.ecr_repository_url }}"
          else
            # Get ECR URL from existing infrastructure
            ECR_URL=$(aws ecr describe-repositories \
              --repository-names ${{ env.PROJECT_NAME }}-system \
              --region ${{ env.AWS_REGION }} \
              --query 'repositories[0].repositoryUri' \
              --output text)
          fi
          
          echo "ecr_url=$ECR_URL" >> $GITHUB_OUTPUT
          echo "ECR Repository: $ECR_URL"

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set image metadata
        id: meta
        run: |
          IMAGE_TAG="${{ github.sha }}"
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Build Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.PROJECT_NAME }}-system
          IMAGE_TAG: ${{ steps.meta.outputs.image_tag }}
        run: |
          set -euo pipefail
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”¨ Building Docker Image"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          docker build \
            --tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            --tag $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            --file Dockerfile \
            .
          
          echo "âœ… Docker image built successfully"

      - name: Push to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.PROJECT_NAME }}-system
          IMAGE_TAG: ${{ steps.meta.outputs.image_tag }}
        run: |
          set -euo pipefail
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¤ Pushing Image to ECR"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "âœ… Image pushed to ECR"
          echo "Image: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

      - name: Update ECS service
        run: |
          set -euo pipefail
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ Updating ECS Service"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          aws ecs update-service \
            --cluster ${{ env.PROJECT_NAME }}-cluster \
            --service ${{ env.PROJECT_NAME }}-service \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… ECS service update initiated"

      - name: Wait for deployment stability
        run: |
          set -euo pipefail
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â³ Waiting for Deployment to Stabilize"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "This may take 2-5 minutes..."
          
          aws ecs wait services-stable \
            --cluster ${{ env.PROJECT_NAME }}-cluster \
            --services ${{ env.PROJECT_NAME }}-service \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Deployment completed and stable"

      - name: Verify deployment
        run: |
          set -euo pipefail
          echo "Verifying deployment..."
          
          SERVICE_INFO=$(aws ecs describe-services \
            --cluster ${{ env.PROJECT_NAME }}-cluster \
            --services ${{ env.PROJECT_NAME }}-service \
            --region ${{ env.AWS_REGION }})
          
          RUNNING_COUNT=$(echo $SERVICE_INFO | jq -r '.services[0].runningCount')
          DESIRED_COUNT=$(echo $SERVICE_INFO | jq -r '.services[0].desiredCount')
          
          echo "Running tasks: $RUNNING_COUNT"
          echo "Desired tasks: $DESIRED_COUNT"
          
          if [ "$RUNNING_COUNT" -eq "$DESIRED_COUNT" ]; then
            echo "âœ… All tasks are running"
          else
            echo "âš ï¸  Warning: Running count ($RUNNING_COUNT) doesn't match desired count ($DESIRED_COUNT)"
          fi

  health-check:
    name: ğŸ¥ Health Check Verification
    needs: [setup-infrastructure, deploy-application]
    if: |
      always() &&
      (needs.setup-infrastructure.result == 'success' || needs.setup-infrastructure.result == 'skipped') &&
      needs.deploy-application.result == 'success'
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Load Balancer URL
        id: get-url
        run: |
          set -euo pipefail
          
          if [ -n "${{ needs.setup-infrastructure.outputs.load_balancer_dns }}" ]; then
            LB_DNS="${{ needs.setup-infrastructure.outputs.load_balancer_dns }}"
          else
            # Get LB DNS from existing infrastructure
            LB_DNS=$(aws elbv2 describe-load-balancers \
              --names ${{ env.PROJECT_NAME }}-alb \
              --region ${{ env.AWS_REGION }} \
              --query 'LoadBalancers[0].DNSName' \
              --output text)
          fi
          
          echo "lb_dns=$LB_DNS" >> $GITHUB_OUTPUT
          echo "Load Balancer: $LB_DNS"

      - name: Wait for load balancer targets
        run: |
          echo "Waiting for targets to register with load balancer..."
          sleep 60

      - name: Health check
        continue-on-error: true
        run: |
          set -euo pipefail
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¥ Running Health Checks"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          URL="http://${{ steps.get-url.outputs.lb_dns }}"
          echo "Testing: $URL"
          
          for i in {1..5}; do
            echo "Attempt $i/5..."
            if curl -f -s -o /dev/null -w "%{http_code}" "$URL" | grep -q "200\|404"; then
              echo "âœ… Health check passed!"
              exit 0
            fi
            echo "Waiting 10 seconds before retry..."
            sleep 10
          done
          
          echo "âš ï¸  Health check did not pass, but deployment may still be warming up"
          echo "Check the application manually at: $URL"

  cost-estimation:
    name: ğŸ’° Cost Estimation
    needs: [setup-infrastructure]
    if: |
      always() &&
      needs.setup-infrastructure.result == 'success'
    runs-on: ubuntu-latest
    
    steps:
      - name: Display cost estimate
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ’° Estimated Monthly Costs"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Resource Breakdown:"
          echo "  â€¢ NAT Gateway:              ~\$32.00/month"
          echo "  â€¢ Application Load Balancer: ~\$16.00/month"
          echo "  â€¢ ECS Fargate (2 tasks):    ~\$15-30/month"
          echo "  â€¢ ECR Storage:              ~\$1-5/month"
          echo "  â€¢ CloudWatch Logs:          ~\$1-3/month"
          echo "  â€¢ Data Transfer:            ~\$5-15/month"
          echo ""
          echo "Total Estimated Cost:        ~\$70-100/month"
          echo ""
          echo "ğŸ’¡ Cost Optimization Tips:"
          echo "  â€¢ Reduce to 1 task for lower traffic: -\$10-15/month"
          echo "  â€¢ Use smaller CPU/memory: -\$5-10/month"
          echo "  â€¢ Remove NAT Gateway (less secure): -\$32/month"
          echo ""
          echo "Monitor costs: AWS Cost Explorer â†’ Filter by Project=chimera"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  deployment-summary:
    name: ğŸ“Š Deployment Summary
    needs: [validate-prerequisites, setup-infrastructure, deploy-application, health-check]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Display final summary
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Chimera AWS Deployment Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“‹ Job Status:"
          echo "  Validation:     ${{ needs.validate-prerequisites.result }}"
          echo "  Infrastructure: ${{ needs.setup-infrastructure.result || 'skipped' }}"
          echo "  Deployment:     ${{ needs.deploy-application.result || 'skipped' }}"
          echo "  Health Check:   ${{ needs.health-check.result || 'skipped' }}"
          echo ""
          
          if [ "${{ needs.setup-infrastructure.outputs.application_url }}" != "" ]; then
            echo "ğŸŒ Application URL:"
            echo "  ${{ needs.setup-infrastructure.outputs.application_url }}"
            echo ""
            echo "âš ï¸  Note: It may take 2-3 minutes for the application to become available"
            echo ""
          fi
          
          echo "ğŸ“Š Next Steps:"
          echo "  1. Access your application using the URL above"
          echo "  2. Monitor logs: aws logs tail /ecs/${{ env.PROJECT_NAME }}-system --follow"
          echo "  3. Check service: aws ecs describe-services --cluster ${{ env.PROJECT_NAME }}-cluster --services ${{ env.PROJECT_NAME }}-service"
          echo "  4. View costs in AWS Cost Explorer (filter by Project=${{ env.PROJECT_NAME }})"
          echo ""
          echo "ğŸ“š Documentation:"
          echo "  â€¢ AWS Deployment Guide: aws/README.md"
          echo "  â€¢ Troubleshooting: aws/README.md#troubleshooting"
          echo "  â€¢ Cost Management: aws/README.md#cost-management"
          echo ""
          
          if [ "${{ needs.validate-prerequisites.result }}" != "success" ] || \
             [ "${{ needs.setup-infrastructure.result }}" = "failure" ] || \
             [ "${{ needs.deploy-application.result }}" = "failure" ]; then
            echo "âŒ Deployment encountered errors. Please check the logs above."
            echo ""
            echo "Common issues:"
            echo "  â€¢ Missing IAM permissions - see aws/iam-policy.json"
            echo "  â€¢ AWS service limits exceeded"
            echo "  â€¢ Docker build failures - check Dockerfile"
            echo ""
            echo "For help, see: aws/README.md#troubleshooting"
          else
            echo "âœ… Deployment completed successfully!"
          fi
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  auto-destroy:
    name: ğŸ—‘ï¸ Auto-Destroy Resources
    needs: [setup-infrastructure, deploy-application, health-check]
    if: |
      always() &&
      github.event.inputs.auto_destroy == 'true' &&
      needs.setup-infrastructure.result == 'success'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Wait before destroying
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸  AUTO-DESTROY ENABLED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Waiting 5 minutes before destroying resources..."
          echo "This gives you time to test the deployment."
          sleep 300

      - name: Terraform Init
        working-directory: ./aws/terraform
        run: terraform init

      - name: Terraform Destroy
        working-directory: ./aws/terraform
        run: |
          echo "Destroying all infrastructure..."
          terraform destroy \
            -var="environment=${{ github.event.inputs.environment }}" \
            -var="aws_region=${{ env.AWS_REGION }}" \
            -var="project_name=${{ env.PROJECT_NAME }}" \
            -auto-approve
          
          echo "âœ… All resources destroyed"
