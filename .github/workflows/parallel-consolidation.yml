name: Run Both Consolidation Tasks in Parallel

on:
  workflow_dispatch:
    inputs:
      task_description:
        description: 'Task description for the autonomous bot'
        required: false
        default: 'Run both consolidation tasks'
        type: string

permissions:
  contents: write
  actions: write

jobs:
  consolidate-and-backup:
    name: Consolidation and Backup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the-basics repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Clone source repositories
        run: |
          mkdir source
          git clone https://github.com/oconnorw225-del/ndax-quantum-engine.git source/ndax-quantum-engine || true
          git clone https://github.com/oconnorw225-del/quantum-engine-dashb.git source/quantum-engine-dashb || true
          git clone https://github.com/oconnorw225-del/shadowforge-ai-trader.git source/shadowforge-ai-trader || true
          git clone https://github.com/oconnorw225-del/repository-web-app.git source/repository-web-app || true
          git clone https://github.com/oconnorw225-del/The-new-ones.git source/The-new-ones || true

      - name: Archive backups
        run: |
          mkdir -p backups
          [ -d source/ndax-quantum-engine ] && tar czf backups/ndax-quantum-engine.tar.gz -C source ndax-quantum-engine || true
          [ -d source/quantum-engine-dashb ] && tar czf backups/quantum-engine-dashb.tar.gz -C source quantum-engine-dashb || true
          [ -d source/shadowforge-ai-trader ] && tar czf backups/shadowforge-ai-trader.tar.gz -C source shadowforge-ai-trader || true
          [ -d source/repository-web-app ] && tar czf backups/repository-web-app.tar.gz -C source repository-web-app || true
          [ -d source/The-new-ones ] && tar czf backups/The-new-ones.tar.gz -C source The-new-ones || true

      - name: Setup directory structure
        run: |
          mkdir -p api backend frontend .github/workflows docs automation tests

      - name: Run consolidation script
        run: |
          bash automation/consolidate.sh

      - name: Commit consolidated code
        run: |
          git config --global user.email "ci-bot@example.com"
          git config --global user.name "CI Bot"
          git add .
          git diff --staged --quiet || git commit -m "Automated consolidation: ${{ inputs.task_description }}"
          git push

  validate-and-test:
    name: Validation and Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the-basics repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm install || echo "No package-lock.json, using npm install"

      - name: Run linting
        continue-on-error: true
        run: |
          npm run lint || echo "Linting completed with warnings"

      - name: Run format check
        continue-on-error: true
        run: |
          npm run format:check || echo "Format check completed"

      - name: Run tests
        continue-on-error: true
        run: |
          npm run test || echo "Tests completed"

      - name: Build project
        continue-on-error: true
        run: |
          npm run build || echo "Build completed"

  summary:
    name: Summary
    needs: [consolidate-and-backup, validate-and-test]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Display summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¤– Autonomous Bot Task Execution Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Task Description: ${{ inputs.task_description }}"
          echo ""
          echo "Job Status:"
          echo "  Consolidation & Backup: ${{ needs.consolidate-and-backup.result }}"
          echo "  Validation & Testing:   ${{ needs.validate-and-test.result }}"
          echo ""
          if [ "${{ needs.consolidate-and-backup.result }}" == "success" ] && [ "${{ needs.validate-and-test.result }}" == "success" ]; then
            echo "âœ… Both tasks completed successfully!"
          elif [ "${{ needs.consolidate-and-backup.result }}" == "success" ]; then
            echo "âœ… Consolidation completed. âš ï¸  Validation had issues."
          elif [ "${{ needs.validate-and-test.result }}" == "success" ]; then
            echo "âš ï¸  Consolidation had issues. âœ… Validation completed."
          else
            echo "âš ï¸  Both tasks encountered issues. Check logs for details."
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
