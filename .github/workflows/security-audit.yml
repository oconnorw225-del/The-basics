name: ğŸ” Security Audit

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: ğŸ§¬ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install psutil
      
      - name: ğŸ” Run Chimera Security Audit
        run: |
          python3 automation/audit.py
        continue-on-error: false
      
      - name: ğŸ“Š Parse audit results
        id: audit_results
        run: |
          if [ -f audit_report.json ]; then
            RISK_LEVEL=$(python3 -c "import json; data=json.load(open('audit_report.json')); print(data['summary']['risk_level'])")
            CRITICAL=$(python3 -c "import json; data=json.load(open('audit_report.json')); print(data['summary']['critical_issues'])")
            HIGH=$(python3 -c "import json; data=json.load(open('audit_report.json')); print(data['summary']['high_issues'])")
            echo "risk_level=$RISK_LEVEL" >> $GITHUB_OUTPUT
            echo "critical_issues=$CRITICAL" >> $GITHUB_OUTPUT
            echo "high_issues=$HIGH" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ“¤ Upload audit report
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report
          path: audit_report.json
          retention-days: 90
      
      - name: âŒ Fail on critical issues
        if: steps.audit_results.outputs.critical_issues != '0'
        run: |
          echo "::error::Critical security issues detected!"
          echo "Review audit_report.json for details"
          exit 1
      
      - name: âš ï¸ Warn on high issues
        if: steps.audit_results.outputs.high_issues != '0' && steps.audit_results.outputs.critical_issues == '0'
        run: |
          echo "::warning::High severity security issues detected"
          echo "Review audit_report.json for details"
      
      - name: âœ… Security check passed
        if: steps.audit_results.outputs.risk_level == 'LOW' || steps.audit_results.outputs.risk_level == 'MEDIUM'
        run: |
          echo "âœ… Security audit passed"
          echo "Risk level: ${{ steps.audit_results.outputs.risk_level }}"
