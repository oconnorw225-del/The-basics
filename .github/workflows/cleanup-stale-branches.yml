name: Cleanup Stale Branches

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode - list branches without deleting (default: true)'
        required: false
        default: true
        type: boolean
      confirm_deletion:
        description: 'Confirm deletion - must be true along with dry_run=false to actually delete branches'
        required: false
        default: false
        type: boolean

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to delete remote branches
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all branches
      
      - name: Configure Git
        run: |
          git config --global user.email "noreply@github.com"
          git config --global user.name "GitHub Actions Bot"
      
      - name: Fetch all branches
        run: |
          git fetch --all --prune
      
      - name: Display configuration
        run: |
          echo "## Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run**: \`${{ inputs.dry_run }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Confirm Deletion**: \`${{ inputs.confirm_deletion }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "Configuration:"
          echo "  Dry Run: ${{ inputs.dry_run }}"
          echo "  Confirm Deletion: ${{ inputs.confirm_deletion }}"
          echo ""
      
      - name: Define branches to delete
        id: branches
        run: |
          # Define the list of stale branches to delete (from DELETE_BRANCHES.sh)
          cat > /tmp/branches_to_delete.txt << 'EOF'
          consolidate/no-clone
          copilot/cleanup-and-merge-branches
          copilot/merge-all-changes
          copilot/merge-feature-branches-into-main
          copilot/remove-copilot-branches
          copilot/setup-codespace-structure
          copilot/setup-directory-structure
          copilot/setup-github-pages-status
          copilot/setup-repo-structure
          copilot/fix-clone-repo-issue
          copilot/fix-railpack-error
          copilot/fix-unexpected-token-error
          copilot/fix-unexpected-token-error-again
          copilot/resolve-issue
          oconnorw225-del-patch-1
          copilot/add-apis-to-repo
          copilot/add-complete-codebase
          copilot/add-may-atonamus-solvency-data
          copilot/add-quantum-dashboard-frontend
          copilot/integrate-related-repositories
          copilot/optimize-synchronization-automation
          copilot/prepare-deployment-for-rainway
          copilot/start-paper-and-live-trading
          copilot/update-authentication-workflow
          copilot/update-consolidation-script
          copilot/consolidate-repository-scripts
          copilot/enhance-synchronization-and-integration
          copilot/merge-unmerged-branches
          dependabot/npm_and_yarn/npm_and_yarn-92f289d509
          EOF
          
          echo "Total branches in deletion list: $(wc -l < /tmp/branches_to_delete.txt)"
      
      - name: Check branch existence
        id: check
        run: |
          echo "## Branch Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Arrays to track branches
          declare -a existing_branches
          declare -a missing_branches
          declare -a protected_branches
          
          # Protected branches that should never be deleted
          PROTECTED=("main" "master")
          
          echo "Checking which branches exist..."
          echo ""
          
          while IFS= read -r branch; do
            # Skip empty lines
            [ -z "$branch" ] && continue
            
            # Check if branch is protected
            is_protected=false
            for protected in "${PROTECTED[@]}"; do
              if [ "$branch" = "$protected" ]; then
                is_protected=true
                break
              fi
            done
            
            if [ "$is_protected" = true ]; then
              echo "‚ö†Ô∏è  PROTECTED: $branch (will NOT be deleted)"
              protected_branches+=("$branch")
              continue
            fi
            
            # Check if branch exists on remote
            if git ls-remote --heads origin "$branch" | grep -q "$branch"; then
              echo "‚úì EXISTS: $branch"
              existing_branches+=("$branch")
            else
              echo "‚ÑπÔ∏è  MISSING: $branch (already deleted or never existed)"
              missing_branches+=("$branch")
            fi
          done < /tmp/branches_to_delete.txt
          
          # Save results for next step
          printf '%s\n' "${existing_branches[@]}" > /tmp/existing_branches.txt
          printf '%s\n' "${missing_branches[@]}" > /tmp/missing_branches.txt
          printf '%s\n' "${protected_branches[@]}" > /tmp/protected_branches.txt
          
          # Count results
          existing_count=${#existing_branches[@]}
          missing_count=${#missing_branches[@]}
          protected_count=${#protected_branches[@]}
          
          echo "existing_count=$existing_count" >> $GITHUB_OUTPUT
          echo "missing_count=$missing_count" >> $GITHUB_OUTPUT
          echo "protected_count=$protected_count" >> $GITHUB_OUTPUT
          
          echo ""
          echo "Summary:"
          echo "  - Branches found: $existing_count"
          echo "  - Branches already deleted: $missing_count"
          echo "  - Branches protected: $protected_count"
      
      - name: Display summary
        run: |
          existing_count=${{ steps.check.outputs.existing_count }}
          missing_count=${{ steps.check.outputs.missing_count }}
          protected_count=${{ steps.check.outputs.protected_count }}
          
          echo "### Summary Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Branches found | $existing_count |" >> $GITHUB_STEP_SUMMARY
          echo "| Branches missing | $missing_count |" >> $GITHUB_STEP_SUMMARY
          echo "| Branches protected | $protected_count |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # List existing branches
          if [ $existing_count -gt 0 ]; then
            echo "### Branches Found (Ready for Deletion)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            while IFS= read -r branch; do
              [ -z "$branch" ] && continue
              echo "- \`$branch\`" >> $GITHUB_STEP_SUMMARY
            done < /tmp/existing_branches.txt
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # List missing branches
          if [ $missing_count -gt 0 ]; then
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Branches Already Deleted ($missing_count)</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            while IFS= read -r branch; do
              [ -z "$branch" ] && continue
              echo "- \`$branch\`" >> $GITHUB_STEP_SUMMARY
            done < /tmp/missing_branches.txt
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # List protected branches
          if [ $protected_count -gt 0 ]; then
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Protected Branches (Never Deleted) ($protected_count)</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            while IFS= read -r branch; do
              [ -z "$branch" ] && continue
              echo "- \`$branch\`" >> $GITHUB_STEP_SUMMARY
            done < /tmp/protected_branches.txt
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Delete branches
        if: steps.check.outputs.existing_count > 0
        run: |
          dry_run="${{ inputs.dry_run }}"
          confirm="${{ inputs.confirm_deletion }}"
          
          echo "## Deletion Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Safety check - require both dry_run=false AND confirm_deletion=true
          if [ "$dry_run" = "true" ] || [ "$confirm" = "false" ]; then
            echo "### üîí DRY RUN MODE - No Branches Deleted" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Safety Check:**" >> $GITHUB_STEP_SUMMARY
            echo "- Dry run is: \`$dry_run\`" >> $GITHUB_STEP_SUMMARY
            echo "- Confirm deletion is: \`$confirm\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**To actually delete branches, you must:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Set \`dry_run\` to \`false\`" >> $GITHUB_STEP_SUMMARY
            echo "2. Set \`confirm_deletion\` to \`true\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The following branches **would be deleted** in a real run:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            while IFS= read -r branch; do
              [ -z "$branch" ] && continue
              echo "- \`$branch\`" >> $GITHUB_STEP_SUMMARY
            done < /tmp/existing_branches.txt
            
            echo ""
            echo "üîí DRY RUN MODE - No branches will be deleted"
            echo ""
            echo "To actually delete branches, rerun with:"
            echo "  - dry_run: false"
            echo "  - confirm_deletion: true"
            echo ""
            exit 0
          fi
          
          # Actually delete branches
          echo "üóëÔ∏è  **DELETING BRANCHES** (dry_run=false, confirm_deletion=true)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "Deleting branches..."
          echo ""
          
          deleted_count=0
          failed_count=0
          
          declare -a deleted_branches
          declare -a failed_branches
          
          while IFS= read -r branch; do
            [ -z "$branch" ] && continue
            
            echo "Deleting: $branch"
            
            if git push origin --delete "$branch" 2>&1; then
              echo "  ‚úì Successfully deleted $branch"
              deleted_branches+=("$branch")
              ((deleted_count++))
            else
              echo "  ‚úó Failed to delete $branch"
              failed_branches+=("$branch")
              ((failed_count++))
            fi
          done < /tmp/existing_branches.txt
          
          echo ""
          echo "Deletion complete!"
          echo "  - Successfully deleted: $deleted_count"
          echo "  - Failed: $failed_count"
          
          # Add results to summary
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ‚úÖ Successfully deleted | $deleted_count |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚ùå Failed to delete | $failed_count |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $deleted_count -gt 0 ]; then
            echo "#### ‚úÖ Successfully Deleted Branches" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            for branch in "${deleted_branches[@]}"; do
              echo "- \`$branch\`" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ $failed_count -gt 0 ]; then
            echo "#### ‚ùå Failed Deletions" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            for branch in "${failed_branches[@]}"; do
              echo "- \`$branch\` (may require manual intervention)" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Don't fail the workflow even if some deletions failed
          exit 0
      
      - name: Final summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow completed at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
